{% extends 'base.html' %} {% block contenido %}
<div class="container mt-4">
  <h1>Atender Solicitud</h1>

  {% if messages %}
  <div class="mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if ultimo.estatus == '1' %}
  <div class="alert alert-warning d-flex justify-content-between align-items-center" role="alert">
    <span><strong>Esta solicitud está pendiente de revisión.</strong> Haga clic en el botón para iniciar el proceso.</span>
    <form method="post" action="{% url 'marcar_solicitud_en_proceso' solicitud.id %}" class="d-inline">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary">Empezar Revisión</button>
    </form>
  </div>
  {% endif %}

  <div>
    <a href="{% url 'listar_solicitudes' %}" class="btn btn-secondary">Volver al Listado</a>
  </div>
  <div class="card mt-4">
    <div class="card-header">
      <h3>Detalles de la Solicitud</h3>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <strong>ID:</strong> {{ solicitud.id }}
        </div>
        <div class="col-md-6">
          <strong>Folio:</strong> {{ solicitud.folio }}
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <strong>Usuario:</strong> {{ solicitud.usuario }}
        </div>
        <div class="col-md-6">
          <strong>Tipo de Solicitud:</strong> {{ solicitud.tipo_solicitud.nombre }}
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <strong>Fecha de Creación:</strong> {{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}
        </div>
        <div class="col-md-6">
          <strong>Estado Actual:</strong>
          <span class="badge bg-{% if ultimo.estatus == '1' %}secondary{% elif ultimo.estatus == '2' %}info{% elif ultimo.estatus == '3' %}success{% else %}danger{% endif %}">
            {{ ultimo.get_estatus_display }}
          </span>
        </div>
      </div>

      {% if solicitud.respuestas.exists %}
      <hr>
      <h4>Respuestas del Formulario</h4>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Campo</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody>
            {% for respuesta in solicitud.respuestas.all %}
            <tr>
              <td><strong>{{ respuesta.campo.etiqueta }}</strong></td>
              <td>{{ respuesta.valor|default:"Sin respuesta" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      {% if solicitud.archivos.exists %}
      <hr>
      <h4>Archivos Adjuntos</h4>
      <ul class="list-group">
        {% for archivo in solicitud.archivos.all %}
        <li class="list-group-item">
          <a href="{{ archivo.archivo.url }}" target="_blank">
            {{ archivo.nombre|default:archivo.archivo.name }}
          </a>
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if solicitud.seguimientos.exists %}
      <hr>
      <h4>Historial de Seguimiento</h4>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            {% for seguimiento in solicitud.seguimientos.all %}
            <tr>
              <td>{{ seguimiento.fecha_creacion|date:"d/m/Y H:i" }}</td>
              <td>
                <span class="badge bg-{% if seguimiento.estatus == '1' %}secondary{% elif seguimiento.estatus == '2' %}info{% elif seguimiento.estatus == '3' %}success{% else %}danger{% endif %}">
                  {{ seguimiento.get_estatus_display }}
                </span>
              </td>
              <td>{{ seguimiento.observaciones|default:"Sin observaciones" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>

    <div class="card-footer">
      {% if ultimo.estatus == '2' %}
      <hr class="my-4">
      <h4>Cerrar Solicitud</h4>
      <form method="post" action="{% url 'cerrar_solicitud' solicitud.id %}">
        {% csrf_token %}

        <div class="mb-3">
          <label for="estatus" class="form-label">Estado Final <span class="text-danger">*</span></label>
          <select class="form-select" id="estatus" name="estatus" required>
            <option value="">Seleccione un estado...</option>
            <option value="3">Terminada</option>
            <option value="4">Cancelada</option>
          </select>
          <div class="form-text">Seleccione el estado final de la solicitud.</div>
        </div>

        <div class="mb-3">
          <label for="observaciones" class="form-label">Observaciones <span class="text-danger">*</span></label>
          <textarea class="form-control" id="observaciones" name="observaciones" rows="4" required placeholder="Ingrese las observaciones finales de la solicitud..."></textarea>
          <div class="form-text">Las observaciones son obligatorias al cerrar la solicitud.</div>
        </div>

        <div class="d-flex justify-content-end gap-2">
          <button type="submit" class="btn btn-success">Cerrar Solicitud</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>

  <div class="mb-5"></div>
</div>
{% endblock contenido %}
